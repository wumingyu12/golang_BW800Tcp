


BW800通讯协议
==============
[TOC]

BW800简单介绍
-------------
1. BW800为南牧研发的智能母猪饲喂器，其会根据母猪怀孕期间到分娩到断奶期间的采食量变化决定母猪当天可采食的量。

2. BW800作为输入的部件有一个为母猪食槽内的顶杆，母猪顶起顶杆时，控制器识别为母猪需要采食。控制器随后会根据当前母猪处在的分娩阶段，当天已经吃的量，当天可以吃的量，当前的时间段等一系列参数确定，是否进行下料。

3. 控制器的输出设备有2个，分别是下料用的电机与加湿饲料用的电磁阀。


BW800 WIFI连接设置
--------------
1. BW800与上位机进行通信通过wifi进行，进行通信时，确保连接上wifi路由可以ping通服务器。BW800连接的wifi路由器的SSID必须是数字（6位）,密码必须是数字（8位）。wifi连接的设置可以在控制器中的 **地址设置** 菜单中设置。

2. 在 **地址设置** 菜单中我们还要设置好服务器的**IP地址**与**端口号**。

3. 在 **地址设置** 菜单中我们还要设置一个**设备地址**，该地址将作为设备的唯一标识。

BW800 登录与心跳机制
-------------------- 
1. BW800正常连接到服务器后，面板上会显示登录。在服务器端观察会发现有一个TCP连接不断发送一条报文，该报文与下面说到的登录报文格式一致。此时服务器端必须回复该登录报文（方法后部分）。如果BW800连续发送**3次登录报文**，服务器端都没有回复，其将会断开此连接，重新进行一次TCP连接。

2. 服务器回复BW800后，BW800的面板将会显示**在线**提示，此时BW800会每隔**1分钟**发送一条心跳报文，此时服务器可以回复任意东西。但如果**4次**心跳报文都没有得到回复，BW800将会重新发送登录报文，进入步骤1。

-----------------------------------------------
BW800报文说明
----------------
### 1. 报文格式
** 报文格式 8A 9B DTYPE DAddr Len C Addr DLen(1) Data  CS **

| 标记         | 说明          | Cool                                                              |
| :----------: |:-------------:| :-----------------------------------------------------------------|
| 8A 9B        | 为包头        | 固定为0x8A 0x9B												   |
| DTYPE        | 设备类型,     | 1字节, BW800 固定为 0x02										   |
| DAddr        | 设备地址,     | 4字节, 如地址为 999(0x3E7), DAddr = 0xE7 0x03 0x00 0x00		   |
| Len          | 长度          | 1字节,  为 C 到 CS(包含)的长度									   |
| C            | 为控制码，    | 最高位为0表示主动发送帧，最高位为1表示回复帧					   |
| Addr	       | 为地址        | 2字节, 如地址是 123 (0x7B) ,Addr = 0x7B 0x00					   |
| DLen(1Byte)  | Data 的长度   |   														           |
| CS           | 校验和        | 为 8A + 9B + Num0 + ... + Data 最后1个字节 的 8位数(高位舍弃)的和 |


-----------------------------------------------

### 2. 读写参数结构体
#### 2.1 参数结构体 开始地址0000  长度184字节
```c
	typedef struct
	{
		U16 totalTable[20];                 //总量曲线 单位10克 1234 表示 12.34kg
	 	U16 timeTStart[10];         		//饲喂时间开始
		U16 timeTEnd[10];           		//饲喂时间结束
		U16 timeTAmount[10];        		//饲喂总量
		U16 calTable[10];                   //校正表 -- g
	 	U16 canOver;                        //允许超出量                -- 10%
	 	U16 xlPer;                          //每次下料多少克 -- 100g
	 	U16 waterAuto;                      //是否自动下水
	 	U16 waterTime;                      //下水时间s
	 	U16 waterSpace;                     //下水间隔s
		U16 usePass;                        //是否使用密码 0 - 不使用 1 - 使用
		U32 addr;                           //控制器地址
		U32 routeName;                      //路由器名称
		U32 routePass;                      //路由器密码
		U32 serverIP[4];                    //服务器IP地址
		U32 serverPort;                     //服务器端口
		U16 stage;                          //0 - 断奶 1 - 产前 2 - 哺乳
		U16 day;                            //第几日
		U16 hasEat;                         //今天已吃 -- g
		U16 eatDelay;                       //要求喂食延迟
	 	U16 sons;                           //仔猪头数
		U8  mday;                           //保存日
		U8  rev;							//保留
	 	U32 password;                       //用户密码
		U32 sum;                            //校验和
	}__czqPara;
```
#### 2.2 C=00 读参数
	Addr 为BW800参数表中要读参数的起始地址，DLen , 为要读的数据长度
	如要读取设备地址为999(0x3E7)的BW800,产前3日以前的饲料总量。
	 
**发送如下报文，读取 *参数结构体   totalTable[0]* ： ** 
	 
| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |
|8A 9B    |  02   | E7 03 00 00 |  05 |  00 |    00    00      |02     |    CS |

**BW800回复 ，0x312 = 786 = 7.86kg:**

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  09 |  80 |    00    00      |02     | 12 03 | CS |


#### 2.3 C=01 写参数
	
** Addr 为BW800参数表中要写参数的起始地址 **

** DLen , 为要写的数据长度 **	

** 如要写设备地址为999(0x3E7)的BW800,参数地址为6 发送如下报文：**

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  07 |  01 |    06    00      |02     | 17 00 | CS |

** NM3000回复成功只有一个字节长度，内容为0 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  06 |  81 |    06    00      |01    | 00 | CS |



-----------------------------------------------

### 3. 读状态结构体

#### 3.1 状态结构体 C=02

```c
	typedef struct
		{
		    U8  hasLog;			//是否已经登录
		    U8  onLine;			//是否在线  0 = 离线 , 1 = 连接到wifi , 2 = 发送登录报文 , 3 = 在线
		    U16 Count;			//内部计时器
		    U32 state;			//输入状态，每位表示一个输入开关量 第一个bit代表顶杆是否触发，其他的31个比特保留
		}__czqState;
```

#### 3.2 C=02 读状态
** 如要读取设备地址为999(0x3E7)的BW800,是否已经登录, 发送如下报文：  **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |
|8A 9B    |  02   | E7 03 00 00 |  05 |  02 |    00    00      |01     |    CS |

** BW800回复 ，已经登录了 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  09 |  82 |    00   00       |01    | 01 | CS |

-----------------------------------------------

### 4. 远程控制 C=03

#### 4.1 读取时间 Addr=0
	
** 如要读取设备地址为999(0x3E7)的BW800 时间, 发送如下报文：  **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |
|8A 9B    |  02   | E7 03 00 00 |  05 |  03 |    00    00      |06     |    CS |

**  BW800回复6字节的时间信息 , 如16年01月10日12时10分22秒 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  09 |  83 |    00   00       |06    | 16 01 10 12 10 22 | CS |

#### 4.2 设置取时间 Addr=1
	
** 如要设置设备地址为999(0x3E7)的BW800 时间为 16年01月10日12时10分22秒, 发送如下报文：  **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  0B |  03 |    01   00       |06    | 16 01 10 12 10 22 | CS |

**  BW800回复6字节的时间信息 , 如16年01月10日12时10分22秒 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  06 |  83 |    01   00       |01    | 00（正确） | CS |

#### 4.3 控制下料 Addr=2
	
** 如要控制设备地址为999(0x3E7)的BW800 下料，发送如下报文：  **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |
|8A 9B    |  02   | E7 03 00 00 |  06 |  03 |    02    00      |00     |    CS |

**  BW800返回 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  06 |  83 |    02   00       |01    | 00（正确） | CS |

#### 4.4 控制下料 Addr=3
	
** 如要读取面板LED状态，发送如下报文：  **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |
|8A 9B    |  02   | E7 03 00 00 |  05 |  03 |    03    00      |02     |    CS |

**  BW800返回 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  07 |  83 |    03   00       |02    | LedState(2bytes) | CS |

	LedState 定义如下，每一位表示一个LED灯的状态，对应位为1时，灯亮，否则灯灭
				 
	LED_ALARM           0x1             //控制器有报警错误

	LED_EATALL          0x2             //今日的料已经吃完了

	LED_EATLEFT	       0x4             //今日的料还有剩余

---------------------------------------------------------------------------

### 5. 读取下料记录

#### 5.1 记录结构体 BW800日记录/  BW800记录明细
```c
	typedef struct
	{
		U32 pigNum;     //猪耳标
		U32 date;       		// C=04 记录    : 日期，如 0x27182 = 160130 = 16年1月30日
								// C=05记录明细: 时标 从1970年1月1日0点0分0秒 到现在的秒数
								// 时标为0或者0xffffffff时，记录无效
		U16 amount;     //总量
		U16 actual;     //实际
		U32 sum;        //校验，校验不正确时，记录无效
	}__czqRec;
```
#### 5.2 读取日下料记录 C=04 
** 最多64条记录 一天一条 **

	Addr 为BW800起始记录编号
	DLen , 为要读多少条记录，最多一次读10条
	注，每条记录长度为16字节

**  如要读取设备地址为999(0x3E7)的BW800,第3条记录开始，读10条记录 发送报文如下 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |
|8A 9B    |  02   | E7 03 00 00 |  05 |  04 |    03    00      |0A     |    CS |

** BW800回复 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  16*10+5 |  84 |    03   00       |0A    | 记录3 记录4 记录5...记录14 | CS |

** 如剩余记录不足，则返回剩余的记录，如上面的例子，剩余记录只有5条，则返回 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  16*5+5 |  84 |    03   00       |05    | 记录3 记录4 记录5...记录9 | CS |

** 如剩余0条记录，则返回 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:|:---:|
|8A 9B    |  02   | E7 03 00 00 |  5+0*16 |  84 |    03   00       |00   | CS |


#### 5.3 读取记录明细 C=05 
** 最多3200条记录 每次下料产生一条 **

	Addr 为BW800起始记录编号
	DLen , 为要读多少条记录，最多一次读10条
	注，每条记录长度为16字节

**  如要读取设备地址为999(0x3E7)的BW800,第3条记录开始，读10条记录 发送报文如下 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |
|8A 9B    |  02   | E7 03 00 00 |  05 |  05 |    03    00      |0A     |    CS |

** BW800回复 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  16*10+5 |  85 |    03   00       |0A    | 记录3 记录4 记录5...记录14 | CS |

** 如剩余记录不足，则返回剩余的记录，如上面的例子，剩余记录只有5条，则返回 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:| :---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  16*5+5 |  85 |    03   00       |05    | 记录3 记录4 记录5...记录9 | CS |

** 如剩余0条记录，则返回 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:|:---:|
|8A 9B    |  02   | E7 03 00 00 |  5+0*16 |  85 |    03   00       |00   | CS |

---------------------------------------------------------------------------------------------

### 6. C=0x10 登录/读取终端信息/心跳/登出

#### 6.1 终端主动登录服务器 Addr = 0

** 服务器收到 控制设备地址为999(0x3E7)的BW800发送的登录报文 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  | TYPE |DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:|:---: |:---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  0A |  10 |    00   00       |05     | 02(设备类型)   | E7 03 00 00 | CS |

** 服务器回复 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  |DATA | CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:|:---:|:---:|
|8A 9B    |  02   | E7 03 00 00 | 06 |  90 |    00   00        |01   |00（正确） |CS |


#### 6.2 服务器读取终端信息

** 服务器发送查询报文 Addr=0 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:|:---:|
|8A 9B    |  FF   | FF FF FF FF |  05 |  10 |    00   00       |05     | CS| 

** 服务器回复 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  |DATA | CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:|:---:|:---:|
|8A 9B    |  02   | E7 03 00 00 | 0A |  90 |    00   00        |05     |02(设备类型) E7 03 00 00(设备地址)  |CS |

#### 6.3 终端主动发送心跳报文

** BW800 发送报文  Addr = 1 如要控制设备地址为999(0x3E7)的BW800发送心跳报文 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  |DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:|:---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  06 |  10 |    01   00       |01     | 00   | CS |

** 服务器回复 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  |DATA | CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:|:---:|:---:|
|8A 9B    |  02   | E7 03 00 00 | 06 |  90 |    01   00        |01   |00（正确） |CS |

#### 6.3 终端主动发送登出报文

** BW800 发送报文  Addr = 2 如要控制设备地址为999(0x3E7)的BW800发送登出报文 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  |DATA  |CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:|:---: |:---:|
|8A 9B    |  02   | E7 03 00 00 |  06 |  10 |    02   00       |01     | 00   | CS |

** 服务器回复 **

| DTYPE   | DTYPE | DADDR       | Len | C   |      Addr        | DLen  |DATA | CS    |
|:-------:|:----: |:----------: | ---:|:---:|:----------------:|:-----:|:---:|:---:|
|8A 9B    |  02   | E7 03 00 00 | 06 |  90 |    02   00        |01   |00（正确） |CS |
